{"componentChunkName":"component---src-templates-post-template-jsx","path":"/blog/playwright-session-recoring-with-jest/","result":{"data":{"site":{"siteMetadata":{"title":"ludeknovy.tech","subtitle":"Thoughts on testing and test automation","copyright":"© All rights reserved.","author":{"name":"","twitter":"#"},"disqusShortname":"","url":"https://www.ludeknovy.tech"}},"markdownRemark":{"id":"6e155b30-a529-55d8-a381-1f428ac0966f","html":"<p>Of course, we all want to have our build with UI tests green all the time, but unfortunately, there are occasions when someone pushes changes and not fully realizing their consequences and the build goes red. Woohoo, debugging time. Back in the days, I was used to recording videos during E2E run time, so it was kind of natural to have them for Playwright UI tests as well. </p>\n<p>Luckily Playwright has an API for it and what more, it is easily configurable to record the browser sessions automatically. All you need to do is to add the <code class=\"language-text\">recordVideo</code> property with a path where the videos will be saved. You pass this setting into browser context settings. In case you use <code class=\"language-text\">jest-playwright</code> you pass it to the <code class=\"language-text\">contextOptions</code>, like this: </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// jest-playwright.config.js\nmodule.exports = {\n  contextOptions: {\n      recordVideo: {\n            dir: &quot;videos/&quot;\n      }\n  },\n  ...\n}</code></pre></div>\n<p>Run your tests and you will find the video recordings in the <code class=\"language-text\">videos</code> folder. Cool, right? But if you have a second look you will notice that the videos have awkward names. And if you have multiple tests it is impossible to link actual tests and videos without opening them individually until you find them. That can be quite annoying while dealing with failed tests. Fortunately, this can be fixed with a little bit of code.\nTo make it work you need to swap jasmin with jest-circus. That’s very easy to do, just install it via npm <code class=\"language-text\">npm install --save-dev jest-circus</code> and the following line into your jest config file:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// jest.config.js\n    ...\n    &quot;testRunner&quot;: &quot;jest-circus/runner&quot;\n    ...</code></pre></div>\n<p>Now jest uses jest-circus as a test runner and it allows us to use its <code class=\"language-text\">handleTestEvent</code> method. The next step is to create a <a href=\"https://jestjs.io/docs/configuration#testenvironment-string\">custom jest environment</a> where we will react on jest events using the <code class=\"language-text\">handleTestEvent</code> method. The goal is to rename the videos after all the tests end and get the test name from jest circus event and change the video name later. Our custom environment could look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">// customEnvironment.js\nconst PlaywrightEnvironment = require(&quot;jest-playwright-preset/lib/PlaywrightEnvironment&quot;)\n    .default\nconst pwConfig = require(&quot;./jest-playwright.config&quot;)\n\n\nclass CustomEnvironment extends PlaywrightEnvironment {\n    constructor(config, context) {\n        super(config, context)\n        this.videos = []\n    }\n    async setup() {\n        await super.setup()\n        // Your setup\n    }\n\n    async teardown() {\n        await super.teardown()\n        // Your teardown\n        if (this.videos.length !== 0) {\n            const { recordVideo } = pwConfig.contextOptions\n\n            this.videos.forEach(video =&gt; {\n                const exists = fs.existsSync(video.videoName)\n                if (exists) {\n                    try {\n                        const newVideoName = `${recordVideo.dir}/${video.testName}.webm`\n                        fs.renameSync(video.videoName, newVideoName)\n                    } catch(error) {\n                        // eslint-disable-next-line no-console\n                        console.log(error)\n                    }\n                }\n\n            })\n        }\n    }\n\n    async handleTestEvent(event) {\n\n        if (event.name === &quot;test_done&quot;) {\n            const success = event.test.errors.length === 0 ? true : false\n            const testName = event.test.name.replace(/ /g, &quot;_&quot;)\n            const videoName = await this.global.page.video().path()\n            this.videos.push({ testName, videoName, success })\n        }\n    }\n}\n\nmodule.exports = CustomEnvironment</code></pre></div>\n<p>I guess you get the idea now. You can easily change the code to keep only failed tests with updated names if wanted. But before we run the tests to check it really works, we need to do one more change in jest config - to plug the custom environment in: </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">//jest.config.js\n...\n    testEnvironment: &quot;./customEnvironment.js&quot;,\n...</code></pre></div>\n<p>That’s it. Run your tests and from now on Playwright session recordings will match the test description names.</p>\n<hr>\n<p>Read more about Playwright:</p>\n<ul>\n<li><a href=\"https://www.ludeknovy.tech/blog/code-coverage-of-e2e-tests-with-playwright/\">Code coverage of E2E with Playwright</a></li>\n</ul>","fields":{"tagSlugs":["/tags/e-2-e/","/tags/playwright/"],"slug":"/blog/playwright-session-recoring-with-jest/"},"frontmatter":{"title":"Playwright session recording with Jest Playwright and Jest circus","tags":["e2e","playwright"],"date":"2021-05-27T02:46:37.121Z","description":"Tutorial on how to record playwright session and rename videos to match test description names"}}},"pageContext":{"slug":"/blog/playwright-session-recoring-with-jest/"}},"staticQueryHashes":[]}